# P0+ å¢å¼ºå®æ–½æ€»ç»“

**æ—¥æœŸ**: 2025-11-24  
**ä»»åŠ¡**: T032-T037 äº§å“èŒƒå›´æ£€ç´¢ä¸äº§å“æŸ¥è¯¢å·¥å…·  
**çŠ¶æ€**: âœ… ä»£ç å®¡æŸ¥å®Œæˆï¼Œæµ‹è¯•æ–‡ä»¶å·²åˆ›å»ºï¼Œå¾…éªŒè¯

---

## ğŸ“‹ å®æ–½å†…å®¹æ¦‚è§ˆ

### 1. å®ªæ³•ä¸è§„èŒƒä¿®æ­£ (CRITICAL)

#### âœ… å·²å®Œæˆ
- **åˆ›å»ºé¡¹ç›®å®ªæ³•** (`.specify/memory/constitution.md`)
  - å®šä¹‰7å¤§æ ¸å¿ƒåŸåˆ™ï¼ˆå‡†ç¡®æ€§ã€Library-Firstã€CLIã€Test-Firstã€å¯è¿½æº¯æ€§ã€è¡¨æ ¼ä¿æŠ¤ã€æ··åˆæ£€ç´¢ï¼‰
  - æ˜ç¡®è´¨é‡é—¨æ§›ï¼ˆæ£€ç´¢å‡†ç¡®æ€§ã€QPSé™åˆ¶ã€åˆè§„æ€§ï¼‰
  - å»ºç«‹æ²»ç†è§„åˆ™

- **æ›´æ–°APIåˆçº¦** (`contracts/mcp-tools.json`)
  - ç”¨4ä¸ªä¸“ä¸šå·¥å…·æ›¿ä»£åŸæœ‰2ä¸ªå·¥å…·
  - æ–°å¢: `lookup_product`, `search_policy_clause`, `check_exclusion_risk`, `calculate_surrender_value_logic`
  - å·¥å…·ç­¾åä¸spec.mdå®Œå…¨å¯¹é½

- **ä¿®æ­£è§„æ ¼ä¹¦** (`spec.md`)
  - æ˜ç¡®FR-008çš„QPSé™åˆ¶å€¼ï¼šâ‰¤0.8 req/sï¼Œç†”æ–­5åˆ†é’Ÿ
  - åˆå¹¶FR-002aåˆ°FR-001ï¼ˆäº§å“èŒƒå›´æ£€ç´¢å¢å¼ºï¼‰
  - æ¾„æ¸…FR-003ç¬¬ä¸€æœŸä»…å®ç°å¹³å®‰äººå¯¿

- **è¡¥å……ä»»åŠ¡** (`tasks.md`)
  - æ–°å¢T014b: robots.txtåˆè§„æ€§æµ‹è¯•
  - æ–°å¢T023c: MetadataExtractorå•å…ƒæµ‹è¯•å®Œå–„
  - æ›´æ–°T032-T037çŠ¶æ€æ ‡è®°

---

### 2. ä»£ç å®¡æŸ¥å‘ç° (P0å¢å¼º)

#### âœ… å·²å®ç°çš„åŠŸèƒ½ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

**T032**: PolicyChunkæ•°æ®æ¨¡å‹
- âœ… å·²åŒ…å« `company`, `product_code`, `product_name`, `doc_type` å­—æ®µ
- âœ… `to_chroma_metadata()` æ­£ç¡®åºåˆ—åŒ–äº§å“å…ƒæ•°æ®
- âœ… `from_chroma_result()` æ­£ç¡®ååºåˆ—åŒ–
- ğŸ“„ æ–‡ä»¶: `src/common/models.py` (L92-96, L152-207)

**T033**: ç´¢å¼•æµç¨‹æ”¯æŒäº§å“å…ƒæ•°æ®
- âœ… `PolicyIndexer.index_document()` è·å–Productä¿¡æ¯å¹¶ä¼ é€’ç»™chunks
- âœ… `ChromaDBStore.add_chunks()` ä¿å­˜å…ƒæ•°æ®åˆ°ChromaDB
- âœ… `ChromaDBStore.search()` æ”¯æŒ `where` å‚æ•°è¿‡æ»¤
- ğŸ“„ æ–‡ä»¶: `src/indexing/indexer.py` (L130-143, L202-208)
- ğŸ“„ æ–‡ä»¶: `src/indexing/vector_store/chroma.py` (L254-329)

**T035**: MCPå·¥å…·æ”¯æŒäº§å“è¿‡æ»¤
- âœ… `search_policy_clause` å·²æ”¯æŒ `company`, `product_code`, `doc_type` å‚æ•°
- âœ… æ£€ç´¢æ—¶æ„å»º `where` æ¡ä»¶è¿›è¡Œè¿‡æ»¤
- ğŸ“„ æ–‡ä»¶: `src/mcp_server/tools/search_policy_clause.py` (L26-29, L54-74)

**T037**: äº§å“æŸ¥è¯¢å·¥å…·
- âœ… `lookup_product()` å®Œæ•´å®ç°ï¼šæ¨¡ç³ŠåŒ¹é…ã€Top-Kã€å…¬å¸è¿‡æ»¤
- âœ… `get_product_by_code()` ç²¾ç¡®æŸ¥è¯¢å®ç°
- âœ… å·²åœ¨MCPæœåŠ¡å™¨ä¸­æ³¨å†Œ
- ğŸ“„ æ–‡ä»¶: `src/mcp_server/product_lookup.py` (L59-137)
- ğŸ“„ æ–‡ä»¶: `src/mcp_server/server.py` (L111-120, L153-179)

---

### 3. æ–°å¢æµ‹è¯•æ–‡ä»¶

#### âœ… T036: äº§å“èŒƒå›´æ£€ç´¢é›†æˆæµ‹è¯•
ğŸ“„ **æ–‡ä»¶**: `tests/integration/test_product_scoped_search.py`

**æµ‹è¯•è¦†ç›–**:
1. `TestProductLookup`: äº§å“æŸ¥è¯¢å·¥å…·
   - æ¨¡ç³ŠåŒ¹é…åŠŸèƒ½
   - æŒ‰ç±»åˆ«æŸ¥è¯¢
   - Top-Kè¿”å›
   - äº§å“ä»£ç ç²¾ç¡®æŸ¥è¯¢

2. `TestProductScopedSearch`: äº§å“èŒƒå›´æ£€ç´¢
   - æŒ‰product_codeè¿‡æ»¤æ£€ç´¢
   - å…¨å±€æ£€ç´¢ï¼ˆå‘åå…¼å®¹ï¼‰
   - æŒ‰doc_typeè¿‡æ»¤
   - Chunkä¸­äº§å“å…ƒæ•°æ®éªŒè¯

3. `TestIndexingWithProductMetadata`: ç´¢å¼•æµç¨‹éªŒè¯
   - éªŒè¯ChunkåŒ…å«äº§å“ä¸Šä¸‹æ–‡

4. `TestEndToEndProductScopedRetrieval`: ç«¯åˆ°ç«¯æµ‹è¯•
   - äº§å“æŸ¥è¯¢ â†’ äº§å“èŒƒå›´æ£€ç´¢å®Œæ•´å·¥ä½œæµ

#### âœ… T014b: åˆè§„æ€§æµ‹è¯•
ğŸ“„ **æ–‡ä»¶**: `tests/unit/test_compliance.py`

**æµ‹è¯•è¦†ç›–**:
1. `TestRateLimiter`: é€Ÿç‡é™åˆ¶å™¨
   - å…¨å±€QPSé™åˆ¶ï¼ˆâ‰¤0.8ï¼‰
   - æ¯åŸŸåç‹¬ç«‹é™åˆ¶
   - 429/403è§¦å‘ç†”æ–­
   - æŒ‡æ•°é€€é¿

2. `TestComplianceMiddleware`: åˆè§„æ€§ä¸­é—´ä»¶
   - robots.txtåè®®éµå®ˆ
   - éšç§è·¯å¾„è¿‡æ»¤
   - è¯·æ±‚è¿‡æ»¤é›†æˆ

3. `TestCircuitBreakerRecovery`: ç†”æ–­æ¢å¤
   - 5åˆ†é’Ÿå†·å´æœºåˆ¶
   - å¤šæ¬¡ç†”æ–­å¤„ç†

4. `TestQPSCompliance`: QPSåˆè§„æ€§
   - éªŒè¯QPSä¿æŒåœ¨0.8ä»¥ä¸‹

#### âœ… T023c: MetadataExtractorå•å…ƒæµ‹è¯•
ğŸ“„ **æ–‡ä»¶**: `tests/unit/test_metadata_extractor.py`

**æµ‹è¯•è¦†ç›–**:
1. `TestCategoryClassification`: æ¡æ¬¾ç±»å‹åˆ†ç±»
   - ä¿é™©è´£ä»»ã€è´£ä»»å…é™¤ã€æµç¨‹ã€å®šä¹‰ã€é€šç”¨

2. `TestEntityRoleIdentification`: ä¸»ä½“è§’è‰²è¯†åˆ«
   - ä¿é™©äººã€è¢«ä¿é™©äººã€å—ç›Šäºº

3. `TestKeywordExtraction`: å…³é”®è¯æå–
   - ä¿é™©é¢†åŸŸå…³é”®è¯
   - å»é‡å’Œåœç”¨è¯è¿‡æ»¤

4. `TestSectionIdExtraction`: æ¡æ¬¾ç¼–å·æå–
   - 1/2/3çº§ç¼–å·

5. `TestEdgeCases`: è¾¹ç•Œæƒ…å†µ
   - æ··åˆæ®µè½ã€è¡¨æ ¼ä¸Šä¸‹æ–‡ã€ç©ºå†…å®¹ã€è¶…é•¿å†…å®¹

6. `TestRegressionSuite`: å›å½’æµ‹è¯•
   - åŸºå‡†æ ·æœ¬éªŒè¯

---

## ğŸš€ éªŒè¯æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé‡å»ºç´¢å¼• (T034 - å¿…é¡»æ‰§è¡Œ)

```bash
# æ¸…ç©ºå¹¶é‡å»ºç´¢å¼•ï¼Œç¡®ä¿æ—§æ•°æ®åŒ…å«äº§å“å…ƒæ•°æ®
python -m src.cli.manage index --rebuild

# éªŒè¯ç´¢å¼•ç»Ÿè®¡
python -m src.cli.manage index stats
```

**é¢„æœŸè¾“å‡º**:
- æ˜¾ç¤ºå·²ç´¢å¼•çš„chunkæ•°é‡
- ç¡®è®¤æ‰€æœ‰chunkåŒ…å«äº§å“å…ƒæ•°æ®

---

### ç¬¬äºŒæ­¥ï¼šè¿è¡Œé›†æˆæµ‹è¯•

```bash
# äº§å“èŒƒå›´æ£€ç´¢æµ‹è¯•
pytest tests/integration/test_product_scoped_search.py -v -s

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
# é¢„æœŸ: æ‰€æœ‰æµ‹è¯•é€šè¿‡æˆ–åˆç†è·³è¿‡ï¼ˆå¦‚æ•°æ®ä¸å­˜åœ¨ï¼‰
```

**å…³é”®éªŒè¯ç‚¹**:
- `test_lookup_product_fuzzy_match`: äº§å“æ¨¡ç³ŠæŸ¥è¯¢æ˜¯å¦æ­£å¸¸
- `test_search_with_product_code_filter`: äº§å“èŒƒå›´æ£€ç´¢æ˜¯å¦ç”Ÿæ•ˆ
- `test_product_metadata_in_chunks`: Chunkæ˜¯å¦åŒ…å«äº§å“å…ƒæ•°æ®
- `test_e2e_workflow`: ç«¯åˆ°ç«¯å·¥ä½œæµæ˜¯å¦é€šç•…

---

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œå•å…ƒæµ‹è¯•

```bash
# åˆè§„æ€§æµ‹è¯•
pytest tests/unit/test_compliance.py -v

# å…ƒæ•°æ®æå–å™¨æµ‹è¯•
pytest tests/unit/test_metadata_extractor.py -v
```

**å…³é”®éªŒè¯ç‚¹**:
- é€Ÿç‡é™åˆ¶å™¨æ˜¯å¦æ­£ç¡®é™åˆ¶QPS
- ç†”æ–­æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
- å…ƒæ•°æ®æå–æ˜¯å¦å‡†ç¡®

---

### ç¬¬å››æ­¥ï¼šæ‰‹åŠ¨åŠŸèƒ½éªŒè¯

#### 4.1 äº§å“æŸ¥è¯¢æµ‹è¯•

```python
# åœ¨Python REPLä¸­æµ‹è¯•
from src.mcp_server.product_lookup import lookup_product

# æµ‹è¯•1: æ¨¡ç³ŠæŸ¥è¯¢
results = lookup_product("ç›ˆæ·»æ‚¦", company="å¹³å®‰äººå¯¿")
print(f"æ‰¾åˆ° {len(results)} ä¸ªäº§å“")
if results:
    print(f"Top 1: {results[0].product_name}")
    print(f"äº§å“ä»£ç : {results[0].product_code}")

# æµ‹è¯•2: è·å–äº§å“ä»£ç ç”¨äºåç»­æ£€ç´¢
product_code = results[0].product_code if results else None
```

#### 4.2 äº§å“èŒƒå›´æ£€ç´¢æµ‹è¯•

```python
from src.mcp_server.tools.search_policy_clause import SearchPolicyClauseTool

search_tool = SearchPolicyClauseTool()

# æµ‹è¯•1: äº§å“èŒƒå›´å†…æ£€ç´¢
results = search_tool.run(
    query="èº«æ•…ä¿é™©é‡‘æ€ä¹ˆèµ”?",
    product_code=product_code,  # ä½¿ç”¨ä¸Šé¢è·å–çš„äº§å“ä»£ç 
    n_results=3
)

print(f"\näº§å“èŒƒå›´æ£€ç´¢ç»“æœ: {len(results)} ä¸ª")
for i, result in enumerate(results, 1):
    print(f"{i}. ç›¸ä¼¼åº¦: {result.similarity_score:.4f}")
    print(f"   ç« èŠ‚: {result.section_title}")
    print(f"   å†…å®¹: {result.content[:100]}...\n")

# æµ‹è¯•2: å…¨å±€æ£€ç´¢å¯¹æ¯”
global_results = search_tool.run(
    query="èº«æ•…ä¿é™©é‡‘æ€ä¹ˆèµ”?",
    company="å¹³å®‰äººå¯¿",
    n_results=3
)

print(f"å…¨å±€æ£€ç´¢ç»“æœ: {len(global_results)} ä¸ª")
```

**é¢„æœŸè§‚å¯Ÿ**:
- äº§å“èŒƒå›´æ£€ç´¢çš„ç›¸ä¼¼åº¦åº”æ˜æ˜¾é«˜äºå…¨å±€æ£€ç´¢ï¼ˆç›®æ ‡ï¼š0.26 â†’ 0.7+ï¼‰
- äº§å“èŒƒå›´æ£€ç´¢çš„ç»“æœåº”æ›´ç²¾å‡†

---

## ğŸ“Š æˆåŠŸæ ‡å‡†

### T036 éªŒè¯é€šè¿‡æ ‡å‡†

1. **äº§å“æŸ¥è¯¢å·¥å…·**
   - âœ… æ¨¡ç³ŠæŸ¥è¯¢"ç›ˆæ·»æ‚¦"èƒ½è¿”å›"å¹³å®‰ç›ˆæ·»æ‚¦ä¸¤å…¨ä¿é™©"
   - âœ… Top-Ké™åˆ¶ç”Ÿæ•ˆï¼ˆæœ€å¤šè¿”å›5ä¸ªï¼‰
   - âœ… å…¬å¸è¿‡æ»¤ç”Ÿæ•ˆ

2. **äº§å“èŒƒå›´æ£€ç´¢**
   - âœ… ä½¿ç”¨product_codeè¿‡æ»¤åï¼Œç›¸ä¼¼åº¦æ˜¾è‘—æå‡ï¼ˆ0.26 â†’ 0.7+ï¼‰
   - âœ… è¿”å›ç»“æœå‡å±äºæŒ‡å®šäº§å“
   - âœ… å…¨å±€æ£€ç´¢ä»æ­£å¸¸å·¥ä½œï¼ˆå‘åå…¼å®¹ï¼‰

3. **Chunkå…ƒæ•°æ®**
   - âœ… ChromaDBä¸­çš„chunkåŒ…å«companyã€product_codeã€product_nameå­—æ®µ
   - âœ… å…ƒæ•°æ®å€¼éç©ºä¸”æ­£ç¡®

---

## âš ï¸ å·²çŸ¥é—®é¢˜ä¸æ³¨æ„äº‹é¡¹

### éœ€è¦æ‰‹åŠ¨æ‰§è¡Œçš„ä»»åŠ¡

1. **T034 - é‡å»ºç´¢å¼•** (30åˆ†é’Ÿ)
   - æ—§æ•°æ®å¯èƒ½ä¸åŒ…å«äº§å“å…ƒæ•°æ®
   - å¿…é¡»è¿è¡Œ `python -m src.cli.manage index --rebuild` é‡å»º

2. **æµ‹è¯•æ•°æ®ä¾èµ–**
   - é›†æˆæµ‹è¯•ä¾èµ–å®é™…æ•°æ®ï¼ˆVERIFIEDæ–‡æ¡£ã€å·²ç´¢å¼•çš„chunksï¼‰
   - å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œéƒ¨åˆ†æµ‹è¯•ä¼š `pytest.skip`

### æµ‹è¯•æ—¶å¯èƒ½çš„å¤±è´¥åŸå› 

1. **äº§å“æŸ¥è¯¢è¿”å›ç©º**
   - åŸå› : æ•°æ®åº“ä¸­æ²¡æœ‰äº§å“æ•°æ®
   - è§£å†³: å…ˆè¿è¡Œ `python -m src.cli.manage crawl run --company pingan-life --limit 10`

2. **äº§å“èŒƒå›´æ£€ç´¢æ— ç»“æœ**
   - åŸå› : ChromaDBä¸­æ²¡æœ‰ç´¢å¼•æ•°æ®
   - è§£å†³: è¿è¡ŒT034é‡å»ºç´¢å¼•

3. **ç›¸ä¼¼åº¦æœªè¾¾åˆ°0.7+**
   - åŸå› : å¯èƒ½éœ€è¦è°ƒæ•´embeddingæ¨¡å‹æˆ–æŸ¥è¯¢æ–¹å¼
   - è§£å†³: è¿™æ˜¯ä¼˜åŒ–ç›®æ ‡ï¼Œéé˜»å¡é—®é¢˜

---

## ğŸ“ åç»­å·¥ä½œ (å¯é€‰)

### ä¼˜åŒ–é¡¹ (éé˜»å¡)

1. **G4**: æ‰©å±•é»„é‡‘æµ‹è¯•é›†åˆ°50é—®é¢˜
   - å½“å‰: 6ä¸ªMVPæµ‹è¯•ç”¨ä¾‹
   - ç›®æ ‡: 50ä¸ªæ ‡å‡†é—®é¢˜ï¼ˆåŸºç¡€20+å¯¹æ¯”15+ä¸“é¡¹15ï¼‰

2. **G5**: è¡¥å……è¡¨æ ¼éªŒè¯æµ‹è¯•
   - éªŒè¯è¡¨æ ¼JSONç»“æ„çš„å®Œæ•´æ€§
   - ç¡®ä¿è¡Œåˆ—å¯¹åº”å…³ç³»ä¸å´©å

3. **æ€§èƒ½ä¼˜åŒ–**
   - ç›‘æ§äº§å“èŒƒå›´æ£€ç´¢çš„å®é™…æ€§èƒ½æå‡
   - æ ¹æ®å®é™…æ•°æ®è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼

---

## ğŸ“š å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡æ¡£
- `specs/001-insurance-mcp-core/spec.md` - åŠŸèƒ½è§„æ ¼ä¹¦
- `specs/001-insurance-mcp-core/tasks.md` - ä»»åŠ¡æ¸…å•
- `specs/001-insurance-mcp-core/contracts/mcp-tools.json` - APIåˆçº¦
- `.specify/memory/constitution.md` - é¡¹ç›®å®ªæ³•

### æ ¸å¿ƒæ–‡ä»¶
- `src/common/models.py` - æ•°æ®æ¨¡å‹
- `src/indexing/indexer.py` - ç´¢å¼•å™¨
- `src/indexing/vector_store/chroma.py` - ChromaDBå­˜å‚¨
- `src/mcp_server/product_lookup.py` - äº§å“æŸ¥è¯¢å·¥å…·
- `src/mcp_server/tools/search_policy_clause.py` - æ¡æ¬¾æ£€ç´¢å·¥å…·
- `src/mcp_server/server.py` - MCPæœåŠ¡å™¨

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [X] å®ªæ³•åˆ›å»ºå¹¶å¡«å……æ ¸å¿ƒåŸåˆ™
- [X] APIåˆçº¦æ›´æ–°ä¸º4ä¸ªå·¥å…·
- [X] è§„æ ¼ä¹¦ä¿®æ­£ï¼ˆQPSå€¼ã€éœ€æ±‚åˆå¹¶ã€æœ¯è¯­ç»Ÿä¸€ï¼‰
- [X] ä»»åŠ¡æ¸…å•è¡¥å……æµ‹è¯•ä»»åŠ¡
- [X] ä»£ç å®¡æŸ¥ç¡®è®¤T032/T033/T035/T037å·²å®ç°
- [X] åˆ›å»ºäº§å“èŒƒå›´æ£€ç´¢é›†æˆæµ‹è¯•
- [X] åˆ›å»ºåˆè§„æ€§å•å…ƒæµ‹è¯•
- [X] åˆ›å»ºMetadataExtractorå•å…ƒæµ‹è¯•
- [X] MCPæœåŠ¡å™¨æ³¨å†Œlookup_productå·¥å…·
- [ ] **å¾…ç”¨æˆ·æ‰§è¡Œ**: é‡å»ºç´¢å¼• (T034)
- [ ] **å¾…ç”¨æˆ·æ‰§è¡Œ**: è¿è¡Œæµ‹è¯•éªŒè¯ (T036)

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-24 02:30 UTC  
**æ€»å·¥ä½œé‡**: çº¦3å°æ—¶ï¼ˆä»£ç å®¡æŸ¥ + æµ‹è¯•ç¼–å†™ + æ–‡æ¡£æ›´æ–°ï¼‰  
**çŠ¶æ€**: âœ… å°±ç»ªå¾…éªŒè¯
