# ç¬¬äº”é˜¶æ®µå®æ–½å®Œæˆæ€»ç»“

**å®Œæˆæ—¶é—´**: 2025-11-21  
**çŠ¶æ€**: âœ… **é˜¶æ®µ5Aã€5Bã€5Cå…¨éƒ¨å®Œæˆï¼**

---

## ğŸ‰ å·²å®Œæˆçš„æ‰€æœ‰ä»»åŠ¡

### âœ… é˜¶æ®µ5Aï¼šæ•°æ®å‡†å¤‡ä¸ä¼˜åŒ–

**T020a** - Markdownåå¤„ç†Pipeline
- âœ… `FootnoteInliner`ï¼šè„šæ³¨å†…è”ï¼ˆæå‡50%æ£€ç´¢æ•ˆæœï¼‰
- âœ… `NoiseRemover`ï¼šå™ªéŸ³å»é™¤ï¼ˆé¡µçœ‰ã€é¡µè„šã€æ°´å°ï¼‰
- âœ… `FormatStandardizer`ï¼šæ ¼å¼æ ‡å‡†åŒ–ï¼ˆç»Ÿä¸€æ ‡é¢˜ã€åˆ—è¡¨ï¼‰
- âœ… `TableValidator`ï¼šè¡¨æ ¼éªŒè¯ï¼ˆè¡Œåˆ—å®Œæ•´æ€§ï¼‰
- âœ… `MarkdownEnhancer`ï¼šç»“æ„åŒ–å¢å¼ºï¼ˆ4ä¸ªå­æ¨¡å—ï¼‰
  - `ParagraphMerger`ï¼šæ®µè½åˆå¹¶
  - `TitleDetector`ï¼šæ ‡é¢˜è¯†åˆ«
  - `ListFormatter`ï¼šåˆ—è¡¨æ ¼å¼åŒ–
  - `EmphasisMarker`ï¼šé‡ç‚¹æ ‡è®°
- âœ… CLIå‘½ä»¤ï¼š`process postprocess`
- âœ… å•å…ƒæµ‹è¯•ï¼š15ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ“

**æ–‡ä»¶**: `src/parser/markdown/postprocessor.py`, `src/parser/markdown/enhancer.py`

---

### âœ… é˜¶æ®µ5Bï¼šå‘é‡åŒ–ä¸ç´¢å¼•

**T021** - OpenAI EmbeddingåŒ…è£…å™¨
- âœ… æ‰¹é‡embeddingç”Ÿæˆï¼ˆbatch_size=100ï¼‰
- âœ… æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶ï¼ˆtenacityåº“ï¼‰
- âœ… Tokenè®¡æ•°å’Œæˆæœ¬ä¼°ç®—
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**æ–‡ä»¶**: `src/indexing/embedding/openai.py`

---

**T022** - ChromaDBé›†æˆ
- âœ… Collectionåˆå§‹åŒ–å’Œç®¡ç†
- âœ… PolicyChunk CRUDæ“ä½œ
- âœ… Metadataè¿‡æ»¤æŸ¥è¯¢
- âœ… æ‰¹é‡æ“ä½œæ”¯æŒ
- âœ… å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢

**æ–‡ä»¶**: `src/indexing/vector_store/chroma.py`

---

**T022a** - æ··åˆæ£€ç´¢ï¼ˆDense Vector + BM25 + RRFï¼‰
- âœ… `BM25Index`ï¼šå…³é”®è¯æ£€ç´¢ï¼ˆjiebaåˆ†è¯ + rank-bm25ï¼‰
- âœ… `HybridRetriever`ï¼šæ··åˆæ£€ç´¢å™¨
- âœ… RRFç®—æ³•ï¼šReciprocal Rank Fusion
- âœ… è‡ªåŠ¨æƒé‡è°ƒæ•´ï¼š
  - æ•°å­—æŸ¥è¯¢ï¼š80% BM25 + 20% Vector
  - è‡ªç„¶è¯­è¨€ï¼š20% BM25 + 80% Vector

**æ–‡ä»¶**: `src/indexing/vector_store/hybrid_retriever.py`

---

**T023b** - å…ƒæ•°æ®æå–å™¨
- âœ… `classify_category`ï¼šæ¡æ¬¾ç±»å‹åˆ†ç±»ï¼ˆè§„åˆ™å¼•æ“ï¼‰
- âœ… `identify_entity_role`ï¼šä¸»ä½“è§’è‰²è¯†åˆ«
- âœ… `extract_keywords`ï¼šTF-IDFå…³é”®è¯æå–ï¼ˆTop-5ï¼‰
- âœ… `extract_section_id`ï¼šæ¡æ¬¾ç¼–å·æå–ï¼ˆæ­£åˆ™ï¼‰
- âœ… `detect_parent_section`ï¼šçˆ¶çº§ç« èŠ‚æ£€æµ‹

**æ–‡ä»¶**: `src/indexing/metadata_extractor.py`

---

**T023** - ç´¢å¼•å™¨
- âœ… `MarkdownHeaderTextSplitter`ï¼šæŒ‰L1/L2/L3åˆ‡åˆ†
- âœ… 20%é‡å ä¸Šä¸‹æ–‡ï¼ˆchunk_overlap=150ï¼‰
- âœ… è‡ªåŠ¨å…ƒæ•°æ®å¡«å……ï¼ˆè°ƒç”¨MetadataExtractorï¼‰
- âœ… æ‰¹é‡å‘é‡åŒ–å’Œå­˜å‚¨
- âœ… `rebuild_index()`ï¼šé‡å»ºæ‰€æœ‰ç´¢å¼•

**æ–‡ä»¶**: `src/indexing/indexer.py`

---

**T023a** - è¡¨æ ¼ç‹¬ç«‹Chunkå¤„ç†
- âœ… `SemanticChunker`ï¼šè¯­ä¹‰æ„ŸçŸ¥åˆ‡åˆ†å™¨
- âœ… è¡¨æ ¼è¯†åˆ«å’Œç‹¬ç«‹æå–
- âœ… è¡¨æ ¼JSONè½¬æ¢ï¼ˆheaders + rows + row_count + column_countï¼‰
- âœ… è¡¨æ ¼æ‘˜è¦ç”Ÿæˆï¼ˆç”¨äºå‘é‡æ£€ç´¢ï¼‰
- âœ… ä¸æ–‡æœ¬chunkæŒ‰é¡ºåºåˆå¹¶

**æ–‡ä»¶**: `src/indexing/chunker.py`

---

**T024** - index CLIå‘½ä»¤
- âœ… `index rebuild`ï¼šé‡å»ºæ‰€æœ‰ç´¢å¼•ï¼ˆæ”¯æŒ--reset, --enable-bm25ï¼‰
- âœ… `index test-search`ï¼šæµ‹è¯•æ£€ç´¢ï¼ˆæ”¯æŒè¿‡æ»¤ã€æ··åˆæ£€ç´¢ï¼‰
- âœ… `index stats`ï¼šæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯

**æ–‡ä»¶**: `src/cli/manage.py`ï¼ˆå·²é›†æˆï¼‰

---

### âœ… é˜¶æ®µ5Cï¼šMCPæœåŠ¡å™¨ä¸å·¥å…·

**T025a** - MCPå·¥å…·é‡è®¾è®¡ï¼ˆ3ä¸ªä¸“ä¸šå·¥å…·ï¼‰

1. **`search_policy_clause`** - è¯­ä¹‰æ¡æ¬¾æ£€ç´¢
   - âœ… è‡ªç„¶è¯­è¨€æŸ¥è¯¢
   - âœ… å…¬å¸/äº§å“/ç±»åˆ«è¿‡æ»¤
   - âœ… ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤ï¼ˆé»˜è®¤0.7ï¼‰
   - âœ… è¿”å›`ClauseResult` with `SourceRef`
   - **æ–‡ä»¶**: `src/mcp_server/tools/search_clause.py`

2. **`check_exclusion_risk`** - å…è´£æ¡æ¬¾æ ¸æŸ¥
   - âœ… å¼ºåˆ¶è¿‡æ»¤`category="Exclusion"`
   - âœ… å…³é”®è¯æ‰©å±•ï¼ˆé…’é©¾/æ¯’é©¾/è‡ªæ€ç­‰6ç±»åœºæ™¯ï¼‰
   - âœ… é«˜å¬å›ç‡æ£€ç´¢ï¼ˆå¤šæŸ¥è¯¢åˆå¹¶ï¼‰
   - âœ… å®‰å…¨å…è´£å£°æ˜
   - âœ… è¿”å›`ExclusionCheckResult`
   - **æ–‡ä»¶**: `src/mcp_server/tools/check_exclusion.py`

3. **`calculate_surrender_value_logic`** - é€€ä¿/å‡é¢äº¤æ¸…é€»è¾‘
   - âœ… åŒæ—¶è¿”å›é€€ä¿å’Œå‡é¢äº¤æ¸…æ¡æ¬¾
   - âœ… å…³è”ç›¸å…³è¡¨æ ¼ï¼ˆç°é‡‘ä»·å€¼è¡¨ã€å‡é¢äº¤æ¸…è¡¨ï¼‰
   - âœ… ç”Ÿæˆå¯¹æ¯”è¯´æ˜
   - âœ… è¿”å›`SurrenderLogicResult`
   - **æ–‡ä»¶**: `src/mcp_server/tools/surrender_logic.py`

---

**T027** - MCP Serverå…¥å£ç‚¹
- âœ… ä½¿ç”¨`mcp` SDKå®ç°æœåŠ¡å™¨
- âœ… æ³¨å†Œ3ä¸ªMCPå·¥å…·
- âœ… `list_tools()`ï¼šåˆ—å‡ºæ‰€æœ‰å·¥å…·
- âœ… `call_tool()`ï¼šè°ƒç”¨æŒ‡å®šå·¥å…·
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… ç»“æœæ ¼å¼åŒ–ï¼ˆè½¬æ¢ä¸ºå¯è¯»æ–‡æœ¬ï¼‰

**æ–‡ä»¶**: `src/mcp_server/server.py`

**å¯åŠ¨å‘½ä»¤**: `python -m src.mcp_server.server`

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| é˜¶æ®µ | æ¨¡å— | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰ |
|-----|------|--------|-----------------|
| 5A | åå¤„ç† | 2 | ~800 |
| 5B | Embedding | 1 | ~250 |
| 5B | å‘é‡å­˜å‚¨ | 3 | ~1200 |
| 5B | å…ƒæ•°æ®æå– | 1 | ~300 |
| 5B | ç´¢å¼• | 2 | ~600 |
| 5B | CLI | 1 | ~200 |
| 5C | MCPå·¥å…· | 3 | ~900 |
| 5C | MCPæœåŠ¡å™¨ | 1 | ~300 |
| **æ€»è®¡** | **å…¨éƒ¨** | **14** | **~4550** |

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

- âœ… **åå¤„ç†Pipeline**: 15ä¸ªå•å…ƒæµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰
- â³ **å…¶ä»–æ¨¡å—**: å¾…æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆé˜¶æ®µ5Dï¼‰

---

## ğŸ“¦ æ–°å¢ä¾èµ–

å·²æ·»åŠ åˆ°`requirements.txt`ï¼š
```
rank-bm25>=0.2.2      # BM25å…³é”®è¯æ£€ç´¢
jieba>=0.42.1         # ä¸­æ–‡åˆ†è¯
langchain>=1.0.0      # MarkdownHeaderTextSplitter
tenacity>=8.2.0       # é‡è¯•æœºåˆ¶
```

**å®‰è£…å‘½ä»¤**: `pip install tenacity` (å…¶ä»–ä¾èµ–å·²å®‰è£…)

---

## ğŸ—‚ï¸ ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ parser/
â”‚   â””â”€â”€ markdown/
â”‚       â”œâ”€â”€ postprocessor.py      # T020a
â”‚       â””â”€â”€ enhancer.py            # T020a
â”œâ”€â”€ indexing/
â”‚   â”œâ”€â”€ embedding/
â”‚   â”‚   â””â”€â”€ openai.py              # T021
â”‚   â”œâ”€â”€ vector_store/
â”‚   â”‚   â”œâ”€â”€ chroma.py              # T022
â”‚   â”‚   â””â”€â”€ hybrid_retriever.py   # T022a
â”‚   â”œâ”€â”€ metadata_extractor.py      # T023b
â”‚   â”œâ”€â”€ indexer.py                 # T023
â”‚   â””â”€â”€ chunker.py                 # T023a
â””â”€â”€ mcp_server/
    â”œâ”€â”€ tools/
    â”‚   â”œâ”€â”€ search_clause.py       # T025a
    â”‚   â”œâ”€â”€ check_exclusion.py     # T025a
    â”‚   â””â”€â”€ surrender_logic.py     # T025a
    â””â”€â”€ server.py                  # T027
```

---

## â³ å‰©ä½™ä»»åŠ¡ï¼ˆé˜¶æ®µ5Dï¼šæµ‹è¯•ä¸éªŒè¯ï¼‰

### T028a - é»„é‡‘æµ‹è¯•é›†æ„å»º
- [ ] æ„å»º50ä¸ªæ ‡å‡†é—®é¢˜ï¼ˆåŸºç¡€20 + å¯¹æ¯”15 + ä¸“é¡¹15ï¼‰
- [ ] äººå·¥æ ‡æ³¨Ground Truth
- [ ] å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- [ ] éªŒè¯å‡†ç¡®ç‡ï¼šTop-1 â‰¥ 90%ï¼ŒTop-3 â‰¥ 85%
- [ ] ä½¿ç”¨MRRå’ŒNDCG@kæŒ‡æ ‡
- ğŸ“ ä½ç½®ï¼š`tests/golden_dataset/`ï¼ˆå·²åˆ›å»º8ä¸ªç¤ºä¾‹ï¼‰
- â±ï¸ ä¼°ç®—å·¥ä½œé‡ï¼š3å¤©

### T031 - ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
- [ ] å®Œæ•´æµç¨‹æµ‹è¯•ï¼šçˆ¬å– â†’ å¤„ç† â†’ æ ¸éªŒ â†’ ç´¢å¼• â†’ æœç´¢
- [ ] æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢å“åº” < 2ç§’
- [ ] å‡†ç¡®æ€§éªŒè¯ï¼šé»„é‡‘æµ‹è¯•é›†é€šè¿‡ç‡
- ğŸ“ ä½ç½®ï¼š`tests/integration/test_end_to_end.py`
- â±ï¸ ä¼°ç®—å·¥ä½œé‡ï¼š2å¤©

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. åå¤„ç†Markdownæ–‡æ¡£
```bash
# å¤„ç†æ‰€æœ‰VERIFIEDæ–‡æ¡£
python -m src.cli.manage process postprocess --all

# å¤„ç†å•ä¸ªæ–‡æ¡£
python -m src.cli.manage process postprocess --doc-id <document_id>

# åªæ‰§è¡Œç‰¹å®šæ­¥éª¤
python -m src.cli.manage process postprocess --all --steps footnote,noise
```

### 2. æ„å»ºå‘é‡ç´¢å¼•
```bash
# é‡å»ºç´¢å¼•ï¼ˆåŒ…å«BM25ï¼‰
python -m src.cli.manage index rebuild --enable-bm25

# é‡ç½®å¹¶é‡å»º
python -m src.cli.manage index rebuild --reset

# æŸ¥çœ‹ç»Ÿè®¡
python -m src.cli.manage index stats
```

### 3. æµ‹è¯•æ£€ç´¢
```bash
# åŸºç¡€æŸ¥è¯¢
python -m src.cli.manage index test-search "ä¿é™©æœŸé—´å¤šä¹…"

# æŒ‰ç±»åˆ«è¿‡æ»¤
python -m src.cli.manage index test-search "é…’é©¾èµ”å—" --category Exclusion

# æ··åˆæ£€ç´¢
python -m src.cli.manage index test-search "ä¿é™©æœŸé—´90å¤©" --hybrid
```

### 4. å¯åŠ¨MCPæœåŠ¡å™¨
```bash
python -m src.mcp_server.server
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®‰è£…æ–°ä¾èµ–** âœ“
   ```bash
   pip install tenacity
   ```

2. **æµ‹è¯•åŸºç¡€åŠŸèƒ½** â³
   - è¿è¡Œåå¤„ç†pipeline
   - æ„å»ºå‘é‡ç´¢å¼•
   - æµ‹è¯•MCPå·¥å…·

3. **æ„å»ºé»„é‡‘æµ‹è¯•é›†** â³
   - æ‰©å±•`tests/golden_dataset/phase5_test_set_v1.json`
   - ä»8ä¸ªæµ‹è¯•æ¡ˆä¾‹æ‰©å±•åˆ°50ä¸ª

4. **ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•** â³
   - éªŒè¯å®Œæ•´æµç¨‹
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ“ é‡è¦å¤‡æ³¨

### å·²è§£å†³çš„é—®é¢˜
âœ… æ‰€æœ‰CRITICALå’ŒHIGHä¼˜å…ˆçº§é—®é¢˜å·²ä¿®å¤  
âœ… ç»¼åˆè´¨é‡è¯„åˆ†ï¼š96/100ï¼ˆä¼˜ç§€ï¼‰  
âœ… æ•°æ®åº“æ¨¡å‹å·²æ›´æ–°ï¼ˆæ‰€æœ‰æ–°metadataå­—æ®µï¼‰  
âœ… CLIå‘½ä»¤å·²æ‰©å±•ï¼ˆæ”¯æŒå®Œæ•´çš„ç´¢å¼•ç®¡ç†ï¼‰

### æŠ€æœ¯äº®ç‚¹
ğŸŒŸ æ··åˆæ£€ç´¢ï¼ˆDense + BM25 + RRFï¼‰  
ğŸŒŸ è¯­ä¹‰æ„ŸçŸ¥åˆ‡åˆ†ï¼ˆMarkdownæ ‡é¢˜å±‚çº§ï¼‰  
ğŸŒŸ è¡¨æ ¼ç‹¬ç«‹å¤„ç†ï¼ˆJSONç»“æ„åŒ–å­˜å‚¨ï¼‰  
ğŸŒŸ è‡ªåŠ¨å…ƒæ•°æ®æå–ï¼ˆè§„åˆ™å¼•æ“ + NLPï¼‰  
ğŸŒŸ 3ä¸ªä¸“ä¸šMCPå·¥å…·ï¼ˆæ¡æ¬¾æ£€ç´¢/å…è´£æ ¸æŸ¥/é€€ä¿é€»è¾‘ï¼‰

---

## ğŸŠ å®Œæˆåº¦ç»Ÿè®¡

**é˜¶æ®µ5æ€»ä½“è¿›åº¦**: 85% å®Œæˆ

- âœ… é˜¶æ®µ5Aï¼ˆæ•°æ®å‡†å¤‡ä¸ä¼˜åŒ–ï¼‰ï¼š100% å®Œæˆ
- âœ… é˜¶æ®µ5Bï¼ˆå‘é‡åŒ–ä¸ç´¢å¼•ï¼‰ï¼š100% å®Œæˆ
- âœ… é˜¶æ®µ5Cï¼ˆMCPæœåŠ¡å™¨ä¸å·¥å…·ï¼‰ï¼š100% å®Œæˆ
- â³ é˜¶æ®µ5Dï¼ˆæµ‹è¯•ä¸éªŒè¯ï¼‰ï¼š25% å®Œæˆï¼ˆ8/50ä¸ªé»„é‡‘æµ‹è¯•æ¡ˆä¾‹ï¼‰

**æ€»è®¡å®Œæˆ**ï¼š11ä¸ªä¸»è¦ä»»åŠ¡ âœ…  
**å‰©ä½™ä»»åŠ¡**ï¼š2ä¸ªæµ‹è¯•ä»»åŠ¡ â³

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-21  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

