# è´¹ç‡è¡¨è§£æä¸å­˜å‚¨æµç¨‹æ–‡æ¡£

**åˆ›å»ºæ—¶é—´**: 2025-11-25  
**ç›¸å…³éœ€æ±‚**: FR-004, FR-009  
**ç›¸å…³ä»»åŠ¡**: T047, T048, T049

---

## ğŸ“‹ æ¦‚è¿°

è´¹ç‡è¡¨ï¼ˆRate Tableï¼‰æ˜¯ä¿é™©äº§å“ä¸­åŒ…å«å¤§é‡æ•°å€¼æ•°æ®çš„è¡¨æ ¼ï¼ˆå¦‚ä¿è´¹è¡¨ã€ç°é‡‘ä»·å€¼è¡¨ç­‰ï¼‰ã€‚æ ¹æ®FR-009çš„è®¾è®¡ï¼Œè´¹ç‡è¡¨éœ€è¦**åˆ†ç¦»å¤„ç†**ï¼š
- âœ… **ä¸è¿›è¡Œå‘é‡åŒ–**ï¼ˆé˜²æ­¢æ•°å€¼å™ªéŸ³å¹²æ‰°è¯­ä¹‰æ£€ç´¢ï¼‰
- âœ… **å¯¼å‡ºä¸ºCSVæ ¼å¼**ï¼ˆä¾¿äºåç»­ç²¾ç¡®æŸ¥è¯¢ï¼‰
- âœ… **åœ¨Chunkä¸­ä¿ç•™å¼•ç”¨**ï¼ˆé€šè¿‡`table_refs`å­—æ®µå…³è”ï¼‰

---

## ğŸ”„ å®Œæ•´å¤„ç†æµç¨‹

### é˜¶æ®µ1: PDFè§£æï¼ˆDoclingParserï¼‰

**ä½ç½®**: `src/indexing/parsers/docling_parser.py`

**æµç¨‹**:
1. ä½¿ç”¨Doclingè§£æPDFæ–‡ä»¶
2. è¯†åˆ«æ–‡æ¡£ä¸­çš„æ‰€æœ‰è¡¨æ ¼å…ƒç´ ï¼ˆ`TableItem`ï¼‰
3. å°†è¡¨æ ¼è½¬æ¢ä¸º`DocTable`å¯¹è±¡ï¼š
   ```python
   DocTable(
       type="table",
       headers=["å¹´é¾„", "ä¿è´¹", "è´¹ç‡"],
       rows=[["30", "1000", "0.01"], ...],
       page_number=1
   )
   ```

**è¾“å‡º**: `ParsedDocument`å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å…ƒç´ ï¼ˆæ–‡æœ¬ã€æ ‡é¢˜ã€è¡¨æ ¼ï¼‰

---

### é˜¶æ®µ2: è¡¨æ ¼åˆ†ç±»ï¼ˆTableClassifierï¼‰

**ä½ç½®**: `src/indexing/analyzers/table_classifier.py`

**åˆ†ç±»è§„åˆ™**:

è´¹ç‡è¡¨è¯†åˆ«æ ‡å‡†ï¼ˆæ»¡è¶³ä»»ä¸€æ¡ä»¶å³åˆ¤å®šä¸ºè´¹ç‡è¡¨ï¼‰ï¼š

1. **å…³é”®è¯åŒ¹é… + æ•°å€¼å¯†åº¦**:
   - è¡¨å¤´æˆ–é¦–è¡ŒåŒ…å«è´¹ç‡å…³é”®è¯ï¼š`["å¹´é¾„", "ä¿è´¹", "è´¹ç‡", "é‡‘é¢", "åˆ©ç›Š", "ç°é‡‘ä»·å€¼"]`
   - **ä¸”** æ•°å€¼å•å…ƒæ ¼å æ¯” > 50%

2. **é«˜æ•°å€¼å¯†åº¦**:
   - æ•°å€¼å•å…ƒæ ¼å æ¯” > 80%ï¼ˆå³ä½¿æ²¡æœ‰æ˜æ˜¾å…³é”®è¯ï¼‰

3. **è¡Œæ•°è¦æ±‚**:
   - è¡¨æ ¼è¡Œæ•° â‰¥ 5ï¼ˆè¿‡æ»¤æ‰è¿‡å°çš„è¡¨æ ¼ï¼‰

**åˆ¤æ–­é€»è¾‘**:
```python
def is_rate_table(self, table: DocTable) -> bool:
    # Rule 1: æ£€æŸ¥å…³é”®è¯
    has_rate_keyword = any(kw in header_text for kw in RATE_KEYWORDS)
    
    # Rule 2: è®¡ç®—æ•°å€¼å¯†åº¦
    numeric_ratio = numeric_cells / total_cells
    
    # å†³ç­–
    if has_rate_keyword and numeric_ratio > 0.5:
        return True
    if numeric_ratio > 0.8:
        return True
    return False
```

**è¾“å‡º**: `True`ï¼ˆè´¹ç‡è¡¨ï¼‰æˆ–`False`ï¼ˆæ™®é€šè¡¨æ ¼ï¼‰

---

### é˜¶æ®µ3: è´¹ç‡è¡¨åºåˆ—åŒ–ï¼ˆTableSerializerï¼‰

**ä½ç½®**: `src/indexing/analyzers/table_serializer.py`

**æµç¨‹**:

1. **ç”Ÿæˆå”¯ä¸€UUID**: ä¸ºæ¯ä¸ªè´¹ç‡è¡¨åˆ†é…å”¯ä¸€æ ‡è¯†ç¬¦
2. **å¯¼å‡ºCSVæ–‡ä»¶**:
   - æ–‡ä»¶è·¯å¾„: `assets/tables/{table_id}.csv`
   - æ ¼å¼: æ ‡å‡†CSVï¼ˆåŒ…å«è¡¨å¤´ï¼‰
   - ç¼–ç : UTF-8

3. **æ›´æ–°å…ƒæ•°æ®ç´¢å¼•**:
   - æ–‡ä»¶: `assets/tables/metadata.json`
   - è®°å½•å†…å®¹:
     ```json
     {
       "table_id": {
         "source_pdf": "/path/to/source.pdf",
         "product_code": "2124",
         "table_type": "RATE_TABLE",
         "csv_path": "table_id.csv",
         "headers": ["å¹´é¾„", "ä¿è´¹", "è´¹ç‡"],
         "row_count": 69,
         "col_count": 10,
         "page_number": 1,
         "created_at": "2025-11-24T17:12:58"
       }
     }
     ```

**è¾“å‡º**: è´¹ç‡è¡¨UUIDï¼ˆç”¨äºåç»­å¼•ç”¨ï¼‰

---

### é˜¶æ®µ4: Markdownç”Ÿæˆä¸å¼•ç”¨æ’å…¥

**ä½ç½®**: `src/indexing/indexer.py` â†’ `_index_with_docling()`

**æµç¨‹**:

å¯¹äºæ¯ä¸ªè¡¨æ ¼å…ƒç´ ï¼š

```python
if isinstance(elem, DocTable):
    is_rate = self.table_classifier.is_rate_table(elem)
    
    if is_rate and config.ENABLE_TABLE_SEPARATION:
        # 1. å¯¼å‡ºè´¹ç‡è¡¨åˆ°CSV
        table_id = self.table_serializer.serialize_rate_table(...)
        rate_table_refs.append(table_id)
        
        # 2. åœ¨Markdownä¸­æ’å…¥å¼•ç”¨æ ‡è®°
        markdown_elements.append(f"\n[è´¹ç‡è¡¨: {table_id}]\n")
    else:
        # æ™®é€šè¡¨æ ¼ï¼šè½¬ä¸ºMarkdownè¡¨æ ¼
        markdown_elements.append(self._table_to_markdown(elem))
```

**Markdownç¤ºä¾‹**:
```markdown
## åŸºæœ¬ä¿é™©é‡‘é¢è¡¨

[è´¹ç‡è¡¨: 65dfe280-752f-4d93-a6c8-ce50f5aafc13]

æ³¨ï¼šæœ¬äº§å“äº¤è´¹æ–¹å¼ä¸ºè¶¸äº¤æˆ–å¹´äº¤ï¼Œæ¯ä»½è¶¸äº¤æˆ–å¹´äº¤ä¿è´¹ 1000 å…ƒã€‚
```

**å…³é”®ç‚¹**:
- âœ… è´¹ç‡è¡¨æ•°æ®**ä¸è¿›å…¥Markdown**ï¼ˆåªä¿ç•™å¼•ç”¨æ ‡è®°ï¼‰
- âœ… æ™®é€šè¡¨æ ¼**è½¬æ¢ä¸ºMarkdownè¡¨æ ¼**ï¼ˆä¿ç•™åœ¨æ–‡æ¡£ä¸­ï¼‰

---

### é˜¶æ®µ5: Chunkç”Ÿæˆä¸ç´¢å¼•

**ä½ç½®**: `src/indexing/indexer.py` â†’ `_index_with_docling()`

**æµç¨‹**:

1. **Markdownåˆ†å—**: ä½¿ç”¨`MarkdownChunker`å¯¹Markdownè¿›è¡Œæ™ºèƒ½åˆ†å—
2. **åˆ›å»ºPolicyChunk**: åŒ…å«è´¹ç‡è¡¨å¼•ç”¨çš„chunkä¼šè®¾ç½®`table_refs`å­—æ®µ
   ```python
   chunk = PolicyChunk(
       content="[ç« èŠ‚: åŸºæœ¬ä¿é™©é‡‘é¢è¡¨]\n[è´¹ç‡è¡¨: 65dfe280-752f-4d93-a6c8-ce50f5aafc13]\næ³¨ï¼š...",
       table_refs=["65dfe280-752f-4d93-a6c8-ce50f5aafc13"],  # è´¹ç‡è¡¨å¼•ç”¨
       doc_type="äº§å“è´¹ç‡è¡¨",
       ...
   )
   ```

3. **å‘é‡åŒ–**: Chunkå†…å®¹ï¼ˆåŒ…å«å¼•ç”¨æ ‡è®°å’Œè¯´æ˜æ–‡å­—ï¼‰ä¼šè¢«å‘é‡åŒ–
4. **å­˜å‚¨åˆ°ChromaDB**: Chunkè¿›å…¥å‘é‡ç´¢å¼•ï¼Œä½†è´¹ç‡è¡¨æ•°æ®æœ¬èº«ä¸å‘é‡åŒ–

**å…³é”®ç‚¹**:
- âœ… Chunkçš„`content`å­—æ®µåŒ…å«ï¼šç« èŠ‚è·¯å¾„ + è´¹ç‡è¡¨å¼•ç”¨æ ‡è®° + è¯´æ˜æ–‡å­—
- âœ… Chunkçš„`table_refs`å­—æ®µåŒ…å«ï¼šæ‰€æœ‰å…³è”çš„è´¹ç‡è¡¨UUIDåˆ—è¡¨
- âœ… è´¹ç‡è¡¨æ•°æ®ï¼ˆCSVï¼‰**ä¸è¿›å…¥å‘é‡ç´¢å¼•**

---

## ğŸ“Š å­˜å‚¨ç»“æ„

### 1. CSVæ–‡ä»¶å­˜å‚¨

**ä½ç½®**: `assets/tables/`

**æ–‡ä»¶å‘½å**: `{table_id}.csv`

**ç¤ºä¾‹**:
```csv
äº¤è´¹æœŸé—´.æŠ•ä¿å¹´é¾„,ç”·æ€§.è¶¸äº¤,ç”·æ€§.3 å¹´äº¤,ç”·æ€§.5 å¹´äº¤,ç”·æ€§.10å¹´äº¤,å¥³æ€§.è¶¸äº¤,å¥³æ€§.3 å¹´äº¤,å¥³æ€§.5 å¹´äº¤,å¥³æ€§.10å¹´äº¤,å¥³æ€§.10å¹´äº¤
0,387750,410000,387750,410000,507472,558105,507472,558105,413900,533622
1,387750,410000,387750,410000,507472,558105,507472,558105,413900,533622
...
```

**ç»Ÿè®¡**: å½“å‰æœ‰ **441ä¸ªCSVæ–‡ä»¶**ï¼ˆçº¦14,579è¡Œæ•°æ®ï¼‰

---

### 2. å…ƒæ•°æ®ç´¢å¼•

**ä½ç½®**: `assets/tables/metadata.json`

**ç»“æ„**:
```json
{
  "table_id": {
    "source_pdf": "/path/to/source.pdf",
    "product_code": "2124",
    "table_type": "RATE_TABLE",
    "csv_path": "table_id.csv",
    "headers": ["åˆ—1", "åˆ—2", ...],
    "row_count": 69,
    "col_count": 10,
    "page_number": 1,
    "created_at": "2025-11-24T17:12:58"
  }
}
```

---

### 3. ChromaDBå­˜å‚¨

**Chunkå†…å®¹ç¤ºä¾‹**:
```
[ç« èŠ‚: ã€Šå¹³å®‰ç¦è€€å¹´é‡‘ä¿é™©ï¼ˆåˆ†çº¢å‹ï¼‰ã€‹åŸºæœ¬ä¿é™©é‡‘é¢è¡¨]

ï¼ˆæ¯ä»½ï¼‰

[è´¹ç‡è¡¨: 65dfe280-752f-4d93-a6c8-ce50f5aafc13]

æ³¨ï¼šæœ¬äº§å“äº¤è´¹æ–¹å¼ä¸ºè¶¸äº¤æˆ–å¹´äº¤ï¼Œæ¯ä»½è¶¸äº¤æˆ–å¹´äº¤ä¿è´¹ 1000 å…ƒã€‚
å•ä½ï¼šäººæ°‘å¸å…ƒ
```

**Metadataå­—æ®µ**:
- `doc_type`: "äº§å“è´¹ç‡è¡¨"
- `table_refs`: `["65dfe280-752f-4d93-a6c8-ce50f5aafc13"]`
- `product_code`: "2124"
- `section_title`: "åŸºæœ¬ä¿é™©é‡‘é¢è¡¨"
- `category`: "General"ï¼ˆæˆ–å…¶ä»–ï¼‰

**ç»Ÿè®¡**: å½“å‰ChromaDBä¸­æœ‰ **86ä¸ªè´¹ç‡è¡¨chunks**ï¼ˆ10.8%ï¼‰

---

## ğŸ” æ£€ç´¢ç­–ç•¥

### å½“å‰å®ç°

**æŸ¥è¯¢è´¹ç‡è¡¨ç›¸å…³é—®é¢˜æ—¶**:
1. è¯­ä¹‰æ£€ç´¢ä¼šåŒ¹é…åŒ…å«è´¹ç‡è¡¨å¼•ç”¨æ ‡è®°çš„chunk
2. è¿”å›çš„chunkåŒ…å«`table_refs`å­—æ®µ
3. å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡`table_refs`è·å–CSVæ–‡ä»¶è·¯å¾„

**ç¤ºä¾‹æŸ¥è¯¢**: "30å²ä¿è´¹å¤šå°‘"
- âœ… ä¼šè¿”å›åŒ…å«è´¹ç‡è¡¨å¼•ç”¨çš„chunk
- âœ… Chunkçš„`table_refs`å­—æ®µåŒ…å«è´¹ç‡è¡¨UUID
- âš ï¸ ä½†æ— æ³•ç›´æ¥æŸ¥è¯¢CSVä¸­çš„å…·ä½“æ•°å€¼

### æœªæ¥ä¼˜åŒ–æ–¹å‘ï¼ˆFR-009æåŠï¼‰

**Text-to-SQLå‡†å¤‡**:
- åç»­é˜¶æ®µå°†åŸºäºCSVè¿›è¡Œç²¾ç¡®æŸ¥è¯¢
- æ”¯æŒç±»ä¼¼SQLçš„æŸ¥è¯¢ï¼š`SELECT ä¿è´¹ FROM rate_table WHERE å¹´é¾„=30 AND æ€§åˆ«='ç”·'`

---

## ğŸ“ˆ æ•°æ®ç»Ÿè®¡

### å½“å‰çŠ¶æ€

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| CSVæ–‡ä»¶æ€»æ•° | 441ä¸ª |
| CSVæ€»è¡Œæ•° | ~14,579è¡Œ |
| ChromaDBè´¹ç‡è¡¨chunks | 86ä¸ª (10.8%) |
| å…ƒæ•°æ®ç´¢å¼•æ¡ç›® | 441æ¡ |

### æ–‡æ¡£ç±»å‹åˆ†å¸ƒï¼ˆChromaDBï¼‰

| æ–‡æ¡£ç±»å‹ | Chunkæ•°é‡ | å æ¯” |
|---------|-----------|------|
| äº§å“æ¡æ¬¾ | 108 | 13.6% |
| äº§å“è¯´æ˜ä¹¦ | 601 | 75.6% |
| **äº§å“è´¹ç‡è¡¨** | **86** | **10.8%** |

---

## âœ… è®¾è®¡ä¼˜åŠ¿

1. **é¿å…æ•°å€¼å™ªéŸ³**: è´¹ç‡è¡¨ä¸å‘é‡åŒ–ï¼Œé˜²æ­¢å¤§é‡æ•°å­—å¹²æ‰°è¯­ä¹‰æ£€ç´¢
2. **ä¿ç•™ä¸Šä¸‹æ–‡**: Chunkä¸­åŒ…å«è´¹ç‡è¡¨çš„è¯´æ˜æ–‡å­—å’Œå¼•ç”¨ï¼Œä¿æŒè¯­ä¹‰å®Œæ•´æ€§
3. **ç²¾ç¡®æŸ¥è¯¢å‡†å¤‡**: CSVæ ¼å¼ä¾¿äºåç»­å®ç°ç²¾ç¡®çš„æ•°å€¼æŸ¥è¯¢
4. **å¯è¿½æº¯æ€§**: é€šè¿‡`table_refs`å’Œ`metadata.json`å¯ä»¥è¿½æº¯åˆ°åŸå§‹PDF

---

## ğŸ”§ é…ç½®é€‰é¡¹

**å¯ç”¨/ç¦ç”¨è´¹ç‡è¡¨åˆ†ç¦»**:
```python
# src/common/config.py
ENABLE_TABLE_SEPARATION = True  # é»˜è®¤å¯ç”¨
```

**è´¹ç‡è¡¨å¯¼å‡ºç›®å½•**:
```python
TABLE_EXPORT_DIR = Path("assets/tables")
```

---

## ğŸ“ ç›¸å…³ä»£ç æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `src/indexing/parsers/docling_parser.py` | PDFè§£æï¼Œè¯†åˆ«è¡¨æ ¼ |
| `src/indexing/analyzers/table_classifier.py` | è¡¨æ ¼åˆ†ç±»ï¼ˆè´¹ç‡è¡¨ vs æ™®é€šè¡¨ï¼‰ |
| `src/indexing/analyzers/table_serializer.py` | è´¹ç‡è¡¨åºåˆ—åŒ–ï¼ˆCSVå¯¼å‡ºï¼‰ |
| `src/indexing/indexer.py` | ç´¢å¼•æµç¨‹åè°ƒ |
| `src/indexing/chunkers/markdown_chunker.py` | Markdownåˆ†å— |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Insurance MCP Team  
**æœ€åæ›´æ–°**: 2025-11-25

