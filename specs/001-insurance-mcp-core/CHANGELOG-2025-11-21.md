# 需求变更记录 - 2025-11-21

## 变更概述

将爬虫策略从"基于IAC索引的全行业采集"调整为"按保险公司维度采集"，第一期聚焦平安人寿公司，以该公司产品为例跑通端到端流程。

## 变更原因

- **目标明确化**: 第一期MVP阶段，聚焦单一公司可以更快验证整体流程
- **降低复杂度**: 避免处理多数据源（IAC + 各公司官网）的复杂逻辑
- **提高可控性**: 单一数据源更容易确保数据质量和准确性
- **验证可行性**: 先用一家公司验证可行性，再扩展到其他公司

## 目标网站

**平安人寿官网 - 公开信息披露栏目**
- URL: https://life.pingan.com/gongkaixinxipilu/baoxianchanpinmulujitiaokuan.jsp
- 提供产品代码、产品名称、报备材料、发布时间等信息

## 文档变更详情

### 1. 功能规格书 (spec.md)

**变更内容**:
- 添加了"最后更新"和"最新变更"记录
- **用户故事3** 修改:
  - 从"基于行业权威索引自动发现"改为"按保险公司维度自动发现"
  - 目标从IAC网站改为平安人寿官网
  - 验收场景更新为针对平安人寿的场景
- **FR-003 功能需求** 修改:
  - 发现层：从"针对IAC等聚合平台"改为"按保险公司维度从目标公司官网采集"
  - 明确第一期针对平安人寿官网
  - 采集层：简化为仅从保险公司官网下载
- **假设与依赖** 增加:
  - 新增：第一期仅实现平安人寿，但架构需支持未来扩展

### 2. 数据模型 (data-model.md)

**变更内容**:
- 添加"第一期范围"说明：company字段固定为"平安人寿"
- Product实体增加 `product_code` 字段（产品代码，用于去重）
- SQLite schema 更新：
  - 增加 `product_code` 字段（UNIQUE约束）
  - `company` 字段默认值设为"平安人寿"
- 数据目录结构调整：
  - 从 `{company}/{year}/` 改为 `pingan-life/{product_code}/`
  - 明确第一期仅创建 `pingan-life` 目录

### 3. 实施计划 (plan.md)

**变更内容**:
- 添加"最后更新"记录
- 摘要更新：明确使用Playwright按保险公司维度爬取，第一期聚焦平安人寿
- 规模/范围调整：从"初期覆盖主要险企"改为"第一期仅覆盖平安人寿一家"

### 4. 任务清单 (tasks.md)

**变更内容**:
- 状态从"待执行"改为"进行中"
- 添加"最后更新"记录
- 第三阶段任务更新：
  - T009：标记为已完成但需配合新任务
  - **T009a (新增)**: 实现平安人寿专用爬虫
  - **T009b (新增)**: 更新CLI命令支持公司参数
  - T011：更新存储路径为 `data/raw/pingan-life/{product_code}/`

### 5. 快速开始 (quickstart.md)

**变更内容**:
- 添加"第一期范围"说明
- 爬虫命令更新：
  - 从 `--source iac` 改为 `--company pingan-life`
  - 添加平安人寿官网URL说明

## 新增文件

### src/crawler/discovery/pingan_life_spider.py

**文件说明**: 平安人寿专用爬虫

**功能特点**:
- 目标网站：https://life.pingan.com/gongkaixinxipilu/baoxianchanpinmulujitiaokuan.jsp
- 提取字段：
  - product_code: 产品代码
  - name: 产品名称
  - company: 保险公司（固定为"平安人寿"）
  - report_materials_url: 产品报备材料链接
  - publish_time: 发布时间
  - source_url: PDF下载链接
- 支持分页
- 支持获取详细信息（PDF链接）

**当前状态**: 
- ✅ 已创建模板文件
- ⚠️ 需要根据实际页面结构完善实现（见T009a任务）

## 待办事项

根据此次变更，以下任务需要优先处理：

1. **[高优先级] T009a**: 完善 `pingan_life_spider.py` 实现
   - 分析平安人寿官网实际页面结构
   - 更新表格选择器和数据提取逻辑
   - 测试爬虫功能

2. **[高优先级] T009b**: 更新 CLI 命令
   - 修改 `src/cli/manage.py` 的 `crawl discover` 命令
   - 支持 `--company pingan-life` 参数
   - 调用正确的爬虫类

3. **[中优先级]** 更新 `save_pipeline.py`
   - 确保文件保存路径符合新的目录结构
   - 支持按产品代码组织目录

4. **[中优先级]** 更新数据库初始化
   - 确保 `products` 表包含 `product_code` 字段
   - 更新相关的数据模型代码

## 架构设计考虑

虽然第一期仅实现平安人寿，但架构设计应考虑未来扩展性：

1. **爬虫抽象**: 
   - 可以考虑定义爬虫基类 `BaseInsuranceSpider`
   - 各保险公司爬虫继承基类，实现统一接口

2. **公司配置**:
   - 建议创建公司配置文件，包含：
     - 公司代码（如 `pingan-life`）
     - 公司名称（如 `平安人寿`）
     - 目标URL
     - 特定的爬虫类

3. **数据存储**:
   - 目录结构已支持多公司：`data/raw/{company_code}/`
   - 数据库 `company` 字段可存储不同公司名称

## 测试建议

1. **爬虫测试**:
   - 手动运行 `pingan_life_spider.py` 脚本测试
   - 验证能否正确提取产品列表
   - 验证PDF链接获取是否正确

2. **端到端测试**:
   - 爬取 → 解析 → 审核 → 索引 → 搜索
   - 使用平安人寿的真实数据验证全流程

3. **合规测试**:
   - 验证QPS限制
   - 确认不会触及隐私数据路径

## 回滚方案

如果需要回滚到原有的IAC爬虫方案：

1. 恢复 spec.md、plan.md、tasks.md 的备份版本
2. 在CLI命令中保留 `--source iac` 参数
3. 保留 `iac_spider.py` 文件（当前仍然存在）

## 总结

此次变更将项目第一期目标从"全行业采集"调整为"单一公司采集"，有助于：
- 快速验证端到端流程可行性
- 降低初期实施复杂度
- 提高数据质量可控性
- 为后续扩展打下良好基础

所有相关文档已同步更新，确保需求、设计和实施保持一致。

